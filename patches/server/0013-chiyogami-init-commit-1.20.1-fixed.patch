From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: bea4dev <bea0224@outlook.jp>
Date: Tue, 13 Jun 2023 22:28:27 +0900
Subject: [PATCH] chiyogami-init-commit-1.20.1-fixed


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 4e0be501d9f4bc244b0222df42b210b7dc377d37..ce823bf72dea37d49735962e691644ed87f573bd 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -291,7 +291,7 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource {
     protected int boardingCooldown;
     @Nullable
     private Entity vehicle;
-    private Level level;
+    public Level level;
     public double xo;
     public double yo;
     public double zo;
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 1b3d46fe962a37d3bed8e4692e17f932527f2083..a6fb662c7bcf3a205dcad478adedf814674c53ad 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -250,12 +250,14 @@ import org.bukkit.scoreboard.Criteria;
 import org.bukkit.structure.StructureManager;
 import org.bukkit.util.StringUtil;
 import org.bukkit.util.permissions.DefaultPermissions;
+import org.spigotmc.AsyncCatcher;
 import org.yaml.snakeyaml.LoaderOptions;
 import org.yaml.snakeyaml.Yaml;
 import org.yaml.snakeyaml.constructor.SafeConstructor;
 import org.yaml.snakeyaml.error.MarkedYAMLException;
 
 import net.md_5.bungee.api.chat.BaseComponent; // Spigot
+import world.chiyogami.thread.WorldThreadPool;
 
 import javax.annotation.Nullable; // Paper
 import javax.annotation.Nonnull; // Paper
@@ -2219,8 +2221,19 @@ public final class CraftServer implements Server {
 
     @Override
     public boolean isPrimaryThread() {
-        return io.papermc.paper.util.TickThread.isTickThread(); // Paper - rewrite chunk system
+        return !AsyncCatcher.isAsync(); // Paper - rewrite chunk system // Chiyogami - thread
     }
+    // Chiyogami start - thread
+    @Override
+    public boolean isMainThread() {
+        return AsyncCatcher.isMainThread();
+    }
+
+    @Override
+    public boolean isWorldThread() {
+        return WorldThreadPool.isWorldThread();
+    }
+    // Chiyogami end
 
     // Paper start - Adventure
     @Override
